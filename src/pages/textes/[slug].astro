---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const entries = await getCollection("articles", ({ data }) => !data.draft);

  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

/* -----------------------------
   Date helpers (robustes)
------------------------------ */
const getDate = (e) => e.data.date ?? e.data.pubDate;
const getTime = (e) => {
  const d = getDate(e);
  return d?.getTime?.() ?? (d ? +new Date(d) : 0);
};

/* -----------------------------
   Next article (chronologique)
------------------------------ */
const all = await getCollection("articles");
const published = all.filter((e) => !e.data.draft);

const sorted = [...published].sort((a, b) => {
  const ad = getTime(a);
  const bd = getTime(b);
  if (ad !== bd) return ad - bd;
  return a.slug.localeCompare(b.slug);
});

const idx = sorted.findIndex((e) => e.slug === entry.slug);
const nextEntry = idx !== -1 && idx < sorted.length - 1 ? sorted[idx + 1] : null;

/* -----------------------------
   SEO logic (clean + lisible)
------------------------------ */
const siloLabel = {
  identite: "Identité numérique",
  empreinte: "Empreinte numérique",
  fatigue: "Fatigue numérique",
};

const silo = entry.data.silo;
const section = siloLabel[silo] ?? "Øui";

const seoTitle = `${entry.data.title} · ${section}`;

const seoDescription =
  entry.data.teaser ??
  entry.data.description ??
  "Un texte sur l’identité, les traces et la présence numérique.";

const canonical = new URL(`/textes/${entry.slug}/`, Astro.site).href;

/* OG / Article meta */
const publishedDate = getDate(entry);
const publishedISO = publishedDate?.toISOString?.();
const updatedISO = entry.data.updated?.toISOString?.();
const author = entry.data.author ?? "Eric Bruet";
const tags = entry.data.tags ?? [];
const ogImage = entry.data.ogImage;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  canonical={canonical}
  ogType="article"
  ogImage={ogImage}
  ogImageAlt={entry.data.title}
  articlePublishedTime={publishedISO}
  articleModifiedTime={updatedISO}
  articleAuthor={author}
  articleSection={section}
  articleTags={tags}
  bodyClass="article-page"
  fullBleed
>
  <main class="article">
    <header>
      <h1>{entry.data.title}</h1>
      {entry.data.description && (
        <div class="article__desc">{entry.data.description}</div>
      )}
    </header>

    <article class="article__body">
      <Content />
    {entry.data.silo && (
        <div class="card" style="margin-top: var(--s5);">
         <h3>Repère</h3>
         <p class="small">
             Lire la page pilier sur{" "}
             <a href={`/${entry.data.silo === "identite" ? "identite-numerique" : entry.data.silo === "empreinte" ? "empreinte-numerique" : "fatigue-numerique"}`}>
            {entry.data.silo === "identite"
             ? "l’identité numérique et la retrouvabilité"
             : entry.data.silo === "empreinte"
             ? "l’empreinte numérique et la persistance"
             : "la fatigue numérique et la pression sociale"}
            </a>.
         </p>
        </div>
        )}

      {nextEntry && (
        <nav class="article-next" aria-label="Texte suivant">
          <a href={`/textes/${nextEntry.slug}/`}>
            <span class="article-next__teaser">
              {nextEntry.data.teaser ?? nextEntry.data.description}
            </span>
            <span class="article-next__title">
              {nextEntry.data.title}
            </span>
          </a>
        </nav>
      )}
    </article>
  </main>
</BaseLayout>
