---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("articles");
  return posts
    .filter((p) => !p.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props;

// rendu markdown/mdx
const { Content } = await post.render();

const title = post.data.title;
const description = post.data.description;

const published = post.data.date;
const updated = post.data.updated;

// Nav prev/next (minimal, basé sur la date)
const all = (await getCollection("articles"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime());

const idx = all.findIndex((p) => p.slug === post.slug);
const prev = idx > 0 ? all[idx - 1] : null;
const next = idx >= 0 && idx < all.length - 1 ? all[idx + 1] : null;
---

<BaseLayout
  title={title}
  description={description}
  ogType="article"
  bodyClass="article"
>
  <article class="prose">
    <header class="article-head">
      <h1>{title}</h1>

      <div class="meta">
        <time datetime={published.toISOString()}>
          {published.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" })}
        </time>

        {updated && (
          <span class="updated">
            · mis à jour le{" "}
            <time datetime={updated.toISOString()}>
              {updated.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" })}
            </time>
          </span>
        )}
      </div>
    </header>

    <Content />

    <nav class="pager" aria-label="Navigation entre articles">
      <div class="prev">
        {prev && <a href={`/articles/${prev.slug}`}>← {prev.data.title}</a>}
      </div>
      <div class="next">
        {next && <a href={`/articles/${next.slug}`}>{next.data.title} →</a>}
      </div>
    </nav>
  </article>

  <style>
    .prose { max-width: 70ch; }

    .article-head h1 { margin: 0 0 .6rem; }
    .meta { opacity: .75; font-size: .95em; }

    .pager {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(0,0,0,.12);
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }
    .pager a { text-decoration: none; }
    .prev, .next { flex: 1; }
    .next { text-align: right; }
  </style>
</BaseLayout>
