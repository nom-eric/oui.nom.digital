---
import "../styles/global.css";
import BrandMark from "../components/BrandMark.astro";

type Props = {
  title?: string;
  description?: string;
  canonical?: string;
  noindex?: boolean;
  bodyClass?: string;
  ogType?: "website" | "article";
  fullBleed?: boolean;

  // Social
  ogImage?: string;
  ogImageAlt?: string;

  // Article OG (optionnels)
  articlePublishedTime?: string;
  articleModifiedTime?: string;
  articleAuthor?: string;
  articleSection?: string;
  articleTags?: string[];
};

const {
  title,
  description,
  canonical,
  noindex = false,
  bodyClass = "",
  ogType,
  ogImage,
  ogImageAlt,

  articlePublishedTime,
  articleModifiedTime,
  articleAuthor,
  articleSection,
  articleTags,

  fullBleed = false,
} = Astro.props as Props;

const siteName = "Øui";
const siteUrl = "https://oui.nom.digital";

const currentPath = Astro.url.pathname;

// SEO fallbacks
const safeTitle = (title && title.trim()) ? title.trim() : siteName;
const safeDescription =
  (description && description.trim())
    ? description.trim()
    : "Un cadre éditorial pour décider, sans bruit.";

// Title tag
const pageTitle = safeTitle === siteName ? siteName : `${safeTitle} · ${siteName}`;

// Canonical robuste + trailing slash homogène
const baseForUrls = Astro.site ?? new URL(siteUrl);

const withTrailingSlash = (href: string) => {
  if (!href) return href;

  // Ne pas toucher aux externes / ancres / mail / tel
  if (/^(https?:)?\/\//.test(href) || href.startsWith("#") || href.startsWith("mailto:") || href.startsWith("tel:")) {
    return href;
  }

  const u = new URL(href, baseForUrls);

  // Ne pas toucher aux fichiers (rss.xml, images, etc.)
  const hasExt = /\.[a-z0-9]{2,5}$/i.test(u.pathname);

  if (!hasExt && u.pathname !== "/" && !u.pathname.endsWith("/")) {
    u.pathname += "/";
  }

  // Retourner un chemin relatif si on reste sur le même host
  // (ça évite de polluer les href avec l'URL absolue)
  return u.origin === baseForUrls.origin ? u.pathname + u.search + u.hash : u.href;
};

const canonicalUrl = new URL(withTrailingSlash(canonical ? canonical : currentPath), baseForUrls).href;

// OG
const ogUrl = canonicalUrl;
const resolvedOgType: "website" | "article" = ogType ?? "website";

// OG image (fallback)
const ogImageUrl = ogImage
  ? new URL(ogImage, baseForUrls).href
  : new URL("/og.png", baseForUrls).href;

const ogImageAltFinal = ogImageAlt ?? safeTitle;

// Nav minimale (figée) + piliers
const nav = [
  { href: "/", label: "Accueil" },
  { href: "/textes", label: "Textes" },

  // Piliers
  { href: "/identite-numerique", label: "Identité" },
  { href: "/empreinte-numerique", label: "Empreinte" },
  { href: "/fatigue-numerique", label: "Fatigue" },

  { href: "/ebook", label: "Ebook" },
];

const isActive = (href: string) => {
  const a = withTrailingSlash(href);
  const p = withTrailingSlash(currentPath);

  if (a === "/") return p === "/";

  // actif si exact ou si on est dans la sous-arbo
  return p === a || p.startsWith(a);
};
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Light-only (cohérent avec global.css) -->
    <meta name="color-scheme" content="light" />
    <meta name="theme-color" content="#EDEFF2" />

    <!-- Fonts (si tu veux les héberger plus tard, easy swap) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;450;600;700;800&family=Source+Serif+4:opsz,wght@8..60,400;450;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- RSS (une seule fois, merci) -->
    <link rel="alternate" type="application/rss+xml" title="RSS — Øui" href="/rss.xml" />

    <title>{pageTitle}</title>
    <meta name="description" content={safeDescription} />
    <link rel="canonical" href={canonicalUrl} />

    <meta name="robots" content={noindex ? "noindex,nofollow" : "index,follow"} />

    <!-- Open Graph / Social -->
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="fr_FR" />
    <meta property="og:type" content={resolvedOgType} />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:title" content={safeTitle} />
    <meta property="og:description" content={safeDescription} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:secure_url" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={ogImageAltFinal} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={safeTitle} />
    <meta name="twitter:description" content={safeDescription} />
    <meta name="twitter:image" content={ogImageUrl} />

    <!-- OG Article -->
    {resolvedOgType === "article" && (
      <>
        {articlePublishedTime && <meta property="article:published_time" content={articlePublishedTime} />}
        {articleModifiedTime && <meta property="article:modified_time" content={articleModifiedTime} />}
        {articleAuthor && <meta property="article:author" content={articleAuthor} />}
        {articleSection && <meta property="article:section" content={articleSection} />}
        {Array.isArray(articleTags) && articleTags.map((tag) => (
          <meta property="article:tag" content={tag} />
        ))}
      </>
    )}

    <!-- Favicons -->
    <link rel="icon" sizes="any" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest/" />
    <slot name="head" />
  </head>

  <body class={bodyClass}>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="/" aria-label="Aller à l’accueil">
          <BrandMark prefix="" suffix="ui" />
          <span class="tagline">Un cadre pour décider.</span>
        </a>

        <nav class="nav" aria-label="Navigation principale">
          {nav
            .filter((i) => i.href !== "/")
            .map((item) => {
              const href = withTrailingSlash(item.href);
              return (
                <a href={href} aria-current={isActive(item.href) ? "page" : undefined}>
                  {item.label}
                </a>
              );
            })}
        </nav>
      </div>
    </header>

    <main class="site-main">
      <div class:list={["container", fullBleed && "full-bleed"]}>
        <slot />
      </div>
    </main>

    <div class="rss-container">
      <a href="/rss.xml" class="rss-link">RSS</a>
    </div>

    <footer class="site-footer">
      <div class="container footer-inner">
        <span class="small footer-left">© {new Date().getFullYear()} <BrandMark prefix="" suffix="ui" class="inline" /></span>
        <nav class="footer-right" aria-label="Liens de pied de page">
          <a href="/textes/" class="small">Textes</a>
          <a href="/identite-numerique/" class="small">Identité</a>
          <a href="/empreinte-numerique/" class="small">Empreinte</a>
          <a href="/fatigue-numerique/" class="small">Fatigue</a>
          <a href="/ebook/" class="small">Ebook</a>
          <a href="/legal/" class="small">Mentions légales</a>
        </nav>
      </div>
    </footer>
  </body>
</html>
